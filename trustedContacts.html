<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trusted Contacts ‚Äì Guardian AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --bg:#f8fafc;
      --card:#ffffff;
      --shadow:0 14px 30px rgba(15,23,42,.06);

      --green:#16a34a;
      --green-bg:#ecfdf5;
      --green-line:#bbf7d0;

      --blue:#2563eb;
      --blue-bg:#eff6ff;
      --blue-line:#bfdbfe;

      --btn:#0f8f5a;
      --btn-hover:#0b7a4c;

      --danger:#ef4444;
      --danger-bg:#fef2f2;
      --danger-line:#fecaca;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* ===================== TOP NAV (STICKY) ===================== */
    .top-nav{
      position: sticky;
      top: 0;
      z-index: 9998;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(226,232,240,.9);
    }
    .top-nav .nav-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .nav-brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:900;
      letter-spacing:-.01em;
      color:#0b1220;
      min-width: 180px;
      text-decoration:none;
    }
    .nav-logo{
      width:42px;height:42px;
      border-radius:14px;
      background: rgba(110,231,184,.14);
      border:1px solid rgba(110,231,184,.34);
      display:grid;place-items:center;
      color:#065f46;
    }
    .nav-title{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .nav-title strong{ font-size:15px; }
    .nav-title span{
      font-size:12px;
      color:#64748b;
      font-weight:800;
      margin-top:2px;
    }

    .nav-links{
      display:flex;
      align-items:center;
      gap: 6px;
      flex: 1;
      justify-content: center;
    }
    .nav-links a{
      font-weight:900;
      font-size:13px;
      color:#0b1220;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      transition: .15s ease;
      white-space: nowrap;
      text-decoration:none;
    }
    .nav-links a:hover{
      background: rgba(15,23,42,.06);
      border-color: rgba(15,23,42,.06);
    }
    .nav-links a.active{
      background: rgba(52,211,153,.18);
      border-color: rgba(52,211,153,.40);
      color:#065f46;
    }

    .nav-actions{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width: 230px;
    }
    .nav-btn{
      height:42px;
      padding: 0 14px;
      border-radius: 12px;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
      color:#0b1220;
      cursor:pointer;
      transition: .15s ease;
      white-space: nowrap;
    }
    .nav-btn:hover{ background: rgba(15,23,42,.04); }
    .nav-btn.primary{
      background: #0b1220;
      border-color: #0b1220;
      color:#fff;
    }
    .nav-btn.primary:hover{ filter: brightness(1.05); }

    .nav-toggle{
      display:none;
      width:44px;height:44px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
      cursor:pointer;
    }
    .nav-toggle span{
      display:block;
      width:18px;height:2px;
      background:#0b1220;
      margin: 4px auto;
      border-radius:99px;
    }

    .nav-mobile{
      display:none;
      border-top:1px solid rgba(226,232,240,.9);
      background: rgba(255,255,255,.92);
    }
    .nav-mobile .nav-mobile-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 18px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .nav-mobile a{
      font-weight:900;
      font-size:14px;
      padding:12px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,.04);
      border: 1px solid rgba(15,23,42,.06);
      text-decoration:none;
      color:#0b1220;
    }
    .nav-mobile a.active{
      background: rgba(52,211,153,.18);
      border-color: rgba(52,211,153,.40);
      color:#065f46;
    }
    .nav-mobile .row{
      display:flex;
      gap:10px;
      margin-top:6px;
    }
    .nav-mobile .row .nav-btn{
      flex:1;
      height:46px;
      border-radius: 14px;
    }

    @media (max-width: 980px){
      .nav-links{ display:none; }
      .nav-actions{ display:none; }
      .nav-toggle{ display:block; margin-left:auto; }
      .nav-brand{ min-width: unset; }
      .top-nav .nav-inner{ padding: 12px 16px; }
      .nav-mobile{ display:block; }
      .nav-mobile[hidden]{ display:none; }
    }
    @media (max-width: 560px){
      .top-nav{ display:none; }
    }
    /* ===================== END TOP NAV ===================== */

    /* ===== MINI BAR (only on very small screens) ===== */
    .mini-bar {
      position: fixed;
      top: 14px;
      left: 14px;
      right: 14px;
      z-index: 9999;
      display: none;
      gap: 8px;
      background: #ffffff;
      padding: 10px 10px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      border: 1px solid rgba(226,232,240,.9);
      align-items:center;
    }
    .mini-bar .mini-left{
      display:flex;
      gap:8px;
      align-items:center;
      flex:1;
      min-width:0;
    }
    .mini-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(52,211,153,.12);
      border:1px solid rgba(52,211,153,.30);
      color:#065f46;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .mini-bar select {
      width:100%;
      min-width:0;
      height:40px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      cursor: pointer;
      background:#fff;
      outline:none;
      font-weight:800;
    }
    .mini-bar button {
      height:40px;
      border: 1px solid rgba(15,23,42,.10);
      background: #f8fafc;
      padding: 0 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .mini-bar button:hover { background: #eef2f7; }

    @media (max-width: 560px){
      .mini-bar{ display:flex; }
      .container{ padding-top: 96px; }
    }

    .container{
      width:min(1180px, calc(100% - 64px));
      margin:0 auto;
      padding:80px 0 110px;
    }

    /* Header */
    .head{
      text-align:center;
      margin-bottom:30px;
    }
    .headIcon{
      width:56px;
      height:56px;
      margin:0 auto 18px;
      border-radius:16px;
      background:#dcfce7;
      display:grid;
      place-items:center;
      color:var(--green);
    }
    h1{
      margin:0 0 10px;
      font-size:36px;
      font-weight:900;
      letter-spacing:-.03em;
    }
    .sub{
      max-width:920px;
      margin:0 auto;
      color:var(--muted);
      font-size:16px;
      line-height:1.65;
      font-weight:600;
    }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:18px 18px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .cardHead h2{
      margin:0;
      font-size:15px;
      font-weight:1000;
      letter-spacing:-.01em;
    }
    .cardHead p{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:650;
      font-size:13px;
      line-height:1.55;
      max-width:900px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1000;
      border:1px solid rgba(15,23,42,.08);
      background:#f1f5f9;
      color:#0f172a;
      white-space:nowrap;
    }
    .pill.copyonly{
      background:var(--green-bg);
      border-color:rgba(22,101,52,.15);
      color:#166534;
    }

    .wrap{ padding:16px 16px 18px; }

    .banner{
      border:1px solid #dbeafe;
      background: linear-gradient(180deg, #eff6ff 0%, #ffffff 100%);
      border-radius:14px;
      padding:14px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .bannerIcon{
      width:42px;height:42px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background:#dbeafe;
      border:1px solid #bfdbfe;
      color:#1d4ed8;
      font-weight:1000;
      flex:0 0 auto;
    }
    .banner h3{
      margin:0;
      font-size:14px;
      font-weight:1000;
      color:#0f172a;
    }
    .banner p{
      margin:6px 0 0;
      color:#475569;
      font-weight:650;
      font-size:12.8px;
      line-height:1.55;
    }

    .controls{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    .ctrl label{
      display:block;
      font-size:12px;
      font-weight:1000;
      color:#0f172a;
      margin-bottom:6px;
    }
    .ctrl input, .ctrl select, .ctrl textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:12px 12px;
      font-weight:700;
      outline:none;
      background:#fff;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:13.5px;
      line-height:1.55;
    }
    .ctrl input, .ctrl select{ height:44px; padding:0 12px; font-weight:800; }
    .ctrl textarea{ min-height:140px; resize:vertical; }
    .ctrl input:focus, .ctrl select:focus, .ctrl textarea:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }
    .hint{
      margin-top:6px;
      color:#64748b;
      font-weight:650;
      font-size:12.5px;
      line-height:1.45;
    }

    .rowActions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      height:42px;
      padding:0 16px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      background:var(--btn);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 12px 22px rgba(15,23,42,.08);
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .btn:hover{ background:var(--btn-hover); }
    .btn.ghost{
      background:#f1f5f9;
      color:#0f172a;
      box-shadow:none;
      border-color:#e5e7eb;
    }
    .btn.ghost:hover{ background:#e5e7eb; }

    .status{
      margin-top:10px;
      display:none;
      border-radius:12px;
      padding:12px 12px;
      font-weight:800;
      font-size:13px;
      line-height:1.5;
      border:1px solid transparent;
    }
    .status.info{ display:block; background:var(--blue-bg); border-color:var(--blue-line); color:#1d4ed8; }
    .status.warn{ display:block; background:var(--danger-bg); border-color:var(--danger-line); color:#991b1b; }

    .preview{
      margin-top:12px;
      border:1px solid #e5e7eb;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .previewHead{
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb;
      background:#f8fafc;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .smallBtn{
      height:38px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      color:#0f172a;
      font-weight:1000;
      font-size:12.8px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .smallBtn:hover{ background:#eef2f7; }

    textarea#output{
      width:100%;
      min-height:200px;
      resize:vertical;
      border:0;
      outline:none;
      padding:12px;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:13.5px;
      line-height:1.55;
      font-weight:650;
      color:#0f172a;
      background:#fff;
    }

    @media (max-width: 980px){
      .container{ width:min(980px, calc(100% - 28px)); }
    }
  </style>
</head>

<body>
  <!-- MINI BAR (small screens) -->
  <div class="mini-bar" role="navigation" aria-label="Quick navigation">
    <div class="mini-left">
      <span class="mini-pill">Guardian AI</span>
      <select id="pageSelect" aria-label="Choose a page">
        <option value="index.html">Home</option>
        <option value="deepfake.html">Deepfake Detector</option>
        <option value="courses.html">Courses</option>
        <option value="trustedContacts.html">Trusted Contacts</option>
        <option value="alerts.html">Alerts</option>
        <option value="simulator.html">Simulator</option>
        <option value="report.html">Report</option>
      </select>
    </div>
    <button type="button" id="miniViewBtn" title="Toggle mobile preview width">Mobile</button>
  </div>

  <!-- TOP NAV -->
  <header class="top-nav">
    <div class="nav-inner">
      <a class="nav-brand" href="javascript:void(0)" onclick="switchPage('index.html')">
        <div class="nav-logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l7 4v7c0 5-3.5 9-7 9s-7-4-7-9V6l7-4z" stroke="currentColor" stroke-width="2"/>
            <path d="M9 12l2 2 4-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="nav-title">
          <strong>Guardian AI</strong>
          <span>Scam Protection</span>
        </div>
      </a>

      <nav class="nav-links" aria-label="Primary">
        <a href="javascript:void(0)" onclick="switchPage('index.html')" data-page="index.html">Home</a>
        <a href="javascript:void(0)" onclick="switchPage('deepfake.html')" data-page="deepfake.html">Deepfake Detector</a>
        <a href="javascript:void(0)" onclick="switchPage('courses.html')" data-page="courses.html">Courses</a>
        <a href="javascript:void(0)" onclick="switchPage('trustedContacts.html')" data-page="trustedcontacts.html" class="active">Trusted Contacts</a>
        <a href="javascript:void(0)" onclick="switchPage('alerts.html')" data-page="alerts.html">Alerts</a>
        <a href="javascript:void(0)" onclick="switchPage('simulator.html')" data-page="simulator.html">Simulator</a>
        <a href="javascript:void(0)" onclick="switchPage('report.html')" data-page="report.html">Report</a>
      </nav>

      <div class="nav-actions">
        <button class="nav-btn" type="button" onclick="switchPage('courses.html')">Start Learning</button>
        <button class="nav-btn primary" type="button" onclick="switchPage('deepfake.html')">Check Media</button>
      </div>

      <button class="nav-toggle" type="button" aria-label="Open menu" aria-expanded="false" id="navToggle">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="nav-mobile" id="navMobile" hidden>
      <div class="nav-mobile-inner">
        <a href="javascript:void(0)" onclick="switchPage('index.html')" data-page="index.html">Home</a>
        <a href="javascript:void(0)" onclick="switchPage('deepfake.html')" data-page="deepfake.html">Deepfake Detector</a>
        <a href="javascript:void(0)" onclick="switchPage('courses.html')" data-page="courses.html">Courses</a>
        <a href="javascript:void(0)" onclick="switchPage('trustedContacts.html')" data-page="trustedcontacts.html" class="active">Trusted Contacts</a>
        <a href="javascript:void(0)" onclick="switchPage('alerts.html')" data-page="alerts.html">Alerts</a>
        <a href="javascript:void(0)" onclick="switchPage('simulator.html')" data-page="simulator.html">Simulator</a>
        <a href="javascript:void(0)" onclick="switchPage('report.html')" data-page="report.html">Report</a>
        <div class="row">
          <button class="nav-btn" type="button" onclick="switchPage('courses.html')">Start Learning</button>
          <button class="nav-btn primary" type="button" onclick="switchPage('deepfake.html')">Check Media</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="head">
      <div class="headIcon" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
          <path d="M16 11a3.2 3.2 0 1 0-6.4 0A3.2 3.2 0 0 0 16 11Z" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20c0-3.2-3.1-5-6.8-5S6.4 16.8 6.4 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>

      <h1>Trusted Contacts</h1>
      <p class="sub">
        Describe what happened. The AI generates a clear verification message you can copy and send to someone you trust.
        This page does not send messages or place calls.
      </p>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <h2>Generate a Verification Message</h2>
          <p>
            Keep it simple. You can paste the suspicious text/email or summarize the call.
            The output is ‚Äúcopy-only‚Äù so you stay in control.
          </p>
        </div>
        <span class="pill copyonly">Copy-only</span>
      </div>

      <div class="wrap">
        <div class="banner">
          <div class="bannerIcon">ü§ù</div>
          <div>
            <h3>Goal: pause + verify</h3>
            <p>We generate a calm message asking for a second opinion and stating safe next steps.</p>
          </div>
        </div>

        <div class="controls">
          <div class="ctrl">
            <label for="recipient">Who are you sending this to? (optional)</label>
            <input id="recipient" placeholder="Example: Mom / Dad / Neighbor" maxlength="28" />
            <div class="hint">Optional. Used only in the greeting.</div>
          </div>

          <div class="ctrl">
            <label for="channel">How were you contacted?</label>
            <select id="channel">
              <option value="phone call">Phone call</option>
              <option value="text message">Text message</option>
              <option value="email">Email</option>
              <option value="social media">Social media</option>
              <option value="other">Other</option>
            </select>
            <div class="hint">Helps the message sound specific.</div>
          </div>

          <div class="ctrl">
            <label for="situation">What happened? (paste or summarize)</label>
            <textarea id="situation" placeholder="Example: I got a text saying my bank account was locked and I need to click a link to verify. They want me to act within 30 minutes." maxlength="1200"></textarea>
            <div class="hint">Tip: You don‚Äôt need every detail. 2‚Äì4 sentences is enough.</div>
          </div>
        </div>

        <div class="rowActions">
          <button class="btn" id="genBtn" type="button">
            Generate Message
          </button>
          <button class="btn ghost" id="resetBtn" type="button">Reset</button>
        </div>

        <div id="status" class="status"></div>

        <div class="preview">
          <div class="previewHead">
            <span class="pill">Generated message</span>
            <button class="smallBtn" id="copyBtn" type="button">Copy</button>
          </div>
          <textarea id="output" readonly></textarea>
        </div>

        <div class="rowActions" style="justify-content:flex-start;">
          <button class="smallBtn" id="copyPlanBtn" type="button">Copy Verification Plan</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- BASE-PATH SAFE NAV ---------------- */
    function getBaseDir() {
      const path = window.location.pathname;
      const parts = path.split("/");
      const last = parts[parts.length - 1];
      if (!last || last.includes(".html")) parts.pop();
      const base = parts.join("/") + (parts.length > 1 ? "/" : "/");
      return base;
    }
    function switchPage(page) {
      if (!page) return;
      if (/^https?:\/\//i.test(page)) { window.location.href = page; return; }
      window.location.href = getBaseDir() + page;
    }

    /* Mini-bar page select */
    (function initMiniBar(){
      const file = (window.location.pathname.split("/").pop() || "index.html").toLowerCase();
      const pageSelect = document.getElementById("pageSelect");
      if (pageSelect){
        [...pageSelect.options].forEach(opt => {
          opt.selected = (opt.value || "").toLowerCase() === file;
        });
        pageSelect.addEventListener("change", () => switchPage(pageSelect.value));
      }
    })();

    /* Nav toggle */
    (function navToggle(){
      const btn = document.getElementById("navToggle");
      const panel = document.getElementById("navMobile");
      if (!btn || !panel) return;
      btn.addEventListener("click", () => {
        const open = !panel.hasAttribute("hidden");
        if (open) {
          panel.setAttribute("hidden", "");
          btn.setAttribute("aria-expanded", "false");
        } else {
          panel.removeAttribute("hidden");
          btn.setAttribute("aria-expanded", "true");
        }
      });
    })();

    /* Mini-bar mobile preview toggle */
    (function miniPreview(){
      const btn = document.getElementById("miniViewBtn");
      if (!btn) return;
      btn.addEventListener("click", () => {
        const meta = document.querySelector('meta[name="viewport"]');
        if (!meta) return;
        if (meta.content.includes("width=375")) {
          meta.content = "width=device-width, initial-scale=1";
          toast("Preview: responsive");
        } else {
          meta.content = "width=375, initial-scale=1";
          toast("Preview: 375px");
        }
      });
    })();

    /* ---------------- AI GENERATION ----------------
       IMPORTANT:
       - This page calls a backend endpoint to generate the message.
       - You must implement /api/generate-verification on your server.
       - The endpoint should return JSON: { "message": "..." }
    -------------------------------------------------- */

    const recipientEl = document.getElementById("recipient");
    const channelEl   = document.getElementById("channel");
    const situationEl = document.getElementById("situation");
    const outEl       = document.getElementById("output");
    const statusEl    = document.getElementById("status");

    const genBtn      = document.getElementById("genBtn");
    const copyBtn     = document.getElementById("copyBtn");
    const resetBtn    = document.getElementById("resetBtn");
    const copyPlanBtn = document.getElementById("copyPlanBtn");

    function setStatus(kind, text){
      statusEl.className = "status " + (kind || "info");
      statusEl.textContent = text || "";
      statusEl.style.display = text ? "block" : "none";
    }

    // A safe fallback if the server is unavailable (still "AI-like" but deterministic).
    function fallbackGenerate({recipient, channel, situation}){
      const who = recipient ? `Hi ${recipient} ‚Äî ` : "Hi ‚Äî ";
      const ch = (channel || "message").toLowerCase();
      const summary = situation ? situation.trim().replace(/\s+/g, " ") : "I received something suspicious.";
      const clipped = summary.length > 360 ? summary.slice(0, 360) + "‚Ä¶" : summary;

      return `${who}quick check before I respond.

I received a suspicious ${ch} and I want a second opinion before doing anything.
What happened: ${clipped}

Can you help me verify:
1) Who this is really from (using official numbers / trusted sources)?
2) Whether I should ignore, block, or report it?

I will not click links, share verification codes, send money, or give remote access until it‚Äôs verified.`;
    }

    async function generateWithServer(payload){
      // Change this if your backend route is different.
      const endpoint = "/api/generate-verification";

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        const txt = await res.text().catch(() => "");
        throw new Error(`Server error ${res.status}${txt ? ": " + txt : ""}`);
      }

      const data = await res.json();
      if (!data || typeof data.message !== "string" || !data.message.trim()){
        throw new Error("Bad response from server (expected { message: string }).");
      }
      return data.message.trim();
    }

    genBtn.addEventListener("click", async () => {
      const situation = situationEl.value.trim();
      if (!situation){
        setStatus("warn", "Please describe what happened (2‚Äì4 sentences is enough).");
        situationEl.focus();
        return;
      }

      const payload = {
        recipient: recipientEl.value.trim(),
        channel: channelEl.value,
        situation: situation,
        // Safety + style constraints you can enforce on the server prompt:
        constraints: {
          tone: "calm, clear, non-accusatory",
          length: "short",
          include_steps: true,
          no_sending: true
        }
      };

      genBtn.disabled = true;
      genBtn.textContent = "Generating‚Ä¶";
      setStatus("info", "Generating a verification message‚Ä¶");

      try{
        const msg = await generateWithServer(payload);
        outEl.value = msg;
        setStatus("info", "Done. Review it, then copy and send it yourself.");
      }catch(err){
        // Fallback: still provide something useful
        outEl.value = fallbackGenerate(payload);
        setStatus("warn", "Couldn‚Äôt reach the AI server. A safe fallback message was generated instead.");
        // (Optional) console log for debugging
        console.warn(err);
      }finally{
        genBtn.disabled = false;
        genBtn.textContent = "Generate Message";
      }
    });

    copyBtn.addEventListener("click", () => {
      const text = outEl.value.trim();
      if (!text){
        toast("Nothing to copy yet.");
        return;
      }
      copyText(text);
      toast("Copied.");
    });

    resetBtn.addEventListener("click", () => {
      recipientEl.value = "";
      channelEl.value = "phone call";
      situationEl.value = "";
      outEl.value = "";
      setStatus("", "");
      situationEl.focus();
      toast("Reset.");
    });

    copyPlanBtn.addEventListener("click", () => {
      const text =
`Quick Verification Plan (Guardian AI)

1) Pause: do not act immediately.
2) Verify independently:
   - Call the company/person using a saved or official number.
   - Never use a number/link provided in the message.
3) Never share:
   - passwords, 2FA codes, gift card numbers, bank login, remote access.
4) If money/info was shared:
   - Contact bank/provider immediately and document what happened.
5) If it feels urgent or secret: treat it as suspicious.`;
      copyText(text);
      toast("Copied verification plan.");
    });

    /* ---------------- UTILITIES ---------------- */
    function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
      }else{
        fallbackCopy(text);
      }
    }
    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(e){}
      document.body.removeChild(ta);
    }

    let toastTimer = null;
    function toast(message){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.bottom = "18px";
        el.style.left = "50%";
        el.style.transform = "translateX(-50%)";
        el.style.background = "#0f172a";
        el.style.color = "#fff";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "12px";
        el.style.fontWeight = "900";
        el.style.fontSize = "13px";
        el.style.boxShadow = "0 14px 30px rgba(0,0,0,.20)";
        el.style.zIndex = "999999";
        el.style.maxWidth = "92vw";
        el.style.textAlign = "center";
        el.style.opacity = "0";
        el.style.transition = "opacity .15s ease";
        document.body.appendChild(el);
      }
      el.textContent = message;
      el.style.opacity = "1";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1400);
    }
  </script>
</body>
</html>
